<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Tutorial - Composing Data Visualizations with Britecharts</title>

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/britecharts@2.11.0/dist/css/britecharts.min.css" type="text/css" />
        <link href="https://fonts.googleapis.com/css?family=Oswald:600" rel="stylesheet">
        <style>
            h1 {
                font-weight: 200;
            }
            html,
            .britechart,
            .tick text {
                font-family: 'Oswald', sans-serif;
            }
            .brush-chart rect.brush-rect.handle {
                fill: #ffa71a;
            }
        </style>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-selection/1.2.0/d3-selection.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/britecharts@2.11.0/dist/bundled/britecharts.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.min.js" type="text/javascript" /></script>
    </head>

    <body>
        <section style="padding: 50px;">
            <h1>Chapter 6: Using and Customizing Britecharts</h1>
            <div class="line-container"></div>
            <div class="legend-container"></div>
            <div class="brush-container"></div>
        </section>

        <script>
            /* global britecharts, d3, _ */

            // Create Dataset with proper shape
            const lineData = {
                "data": [
                    {
                        "name": -1,
                        "topicName": "Vivid",
                        "value": 0,
                        "date": "2016-08-01T00:00:00-07:00"
                    },
                    {
                        "name": -1,
                        "topicName": "Vivid",
                        "value": 3,
                        "date": "2016-08-02T00:00:00-07:00"
                    },
                    {
                        "name": -1,
                        "topicName": "Vivid",
                        "value": 1,
                        "date": "2016-08-03T00:00:00-07:00"
                    },
                    {
                        "name": -1,
                        "topicName": "Vivid",
                        "value": 3,
                        "date": "2016-08-04T00:00:00-07:00"
                    },
                    {
                        "name": -1,
                        "topicName": "Vivid",
                        "value": 3,
                        "date": "2016-08-05T00:00:00-07:00"
                    },
                    {
                        "name": -1,
                        "topicName": "Vivid",
                        "value": 0,
                        "date": "2016-08-06T00:00:00-07:00"
                    },
                    {
                        "name": -1,
                        "topicName": "Vivid",
                        "value": 1,
                        "date": "2016-08-07T00:00:00-07:00"
                    },
                    {
                        "name": -1,
                        "topicName": "Vivid",
                        "value": 1,
                        "date": "2016-08-08T00:00:00-07:00"
                    },
                    {
                        "name": -1,
                        "topicName": "Vivid",
                        "value": 0,
                        "date": "2016-08-09T00:00:00-07:00"
                    },
                    {
                        "name": -1,
                        "topicName": "Vivid",
                        "value": 3,
                        "date": "2016-08-10T00:00:00-07:00"
                    },
                    {
                        "name": -1,
                        "topicName": "Vivid",
                        "value": 4,
                        "date": "2016-08-11T00:00:00-07:00"
                    },
                    {
                        "name": -1,
                        "topicName": "Vivid",
                        "value": 4,
                        "date": "2016-08-12T00:00:00-07:00"
                    },
                    {
                        "name": -1,
                        "topicName": "Vivid",
                        "value": 2,
                        "date": "2016-08-13T00:00:00-07:00"
                    },
                    {
                        "name": -1,
                        "topicName": "Vivid",
                        "value": 3,
                        "date": "2016-08-14T00:00:00-07:00"
                    },
                    {
                        "name": -1,
                        "topicName": "Vivid",
                        "value": 0,
                        "date": "2016-08-15T00:00:00-07:00"
                    },
                    {
                        "name": -1,
                        "topicName": "Vivid",
                        "value": 1,
                        "date": "2016-08-16T00:00:00-07:00"
                    },
                    {
                        "name": -1,
                        "topicName": "Vivid",
                        "value": 0,
                        "date": "2016-08-17T00:00:00-07:00"
                    },
                    {
                        "name": -1,
                        "topicName": "Vivid",
                        "value": 2,
                        "date": "2016-08-18T00:00:00-07:00"
                    },
                    {
                        "name": -1,
                        "topicName": "Vivid",
                        "value": 5,
                        "date": "2016-08-19T00:00:00-07:00"
                    },
                    {
                        "name": -1,
                        "topicName": "Vivid",
                        "value": 1,
                        "date": "2016-08-20T00:00:00-07:00"
                    },
                    {
                        "name": -1,
                        "topicName": "Vivid",
                        "value": 2,
                        "date": "2016-08-21T00:00:00-07:00"
                    },
                    {
                        "name": -1,
                        "topicName": "Vivid",
                        "value": 8,
                        "date": "2016-08-22T00:00:00-07:00"
                    },
                    {
                        "name": -1,
                        "topicName": "Vivid",
                        "value": 4,
                        "date": "2016-08-23T00:00:00-07:00"
                    },
                    {
                        "name": -1,
                        "topicName": "Vivid",
                        "value": 3,
                        "date": "2016-08-24T00:00:00-07:00"
                    },
                    {
                        "name": -1,
                        "topicName": "Vivid",
                        "value": 2,
                        "date": "2016-08-25T00:00:00-07:00"
                    },
                    {
                        "name": -1,
                        "topicName": "Vivid",
                        "value": 5,
                        "date": "2016-08-26T00:00:00-07:00"
                    },
                    {
                        "name": 2,
                        "topicName": "Radiant",
                        "value": 3,
                        "date": "2016-08-01T00:00:00-07:00"
                    },
                    {
                        "name": 2,
                        "topicName": "Radiant",
                        "value": 2,
                        "date": "2016-08-02T00:00:00-07:00"
                    },
                    {
                        "name": 2,
                        "topicName": "Radiant",
                        "value": 2,
                        "date": "2016-08-03T00:00:00-07:00"
                    },
                    {
                        "name": 2,
                        "topicName": "Radiant",
                        "value": 1,
                        "date": "2016-08-04T00:00:00-07:00"
                    },
                    {
                        "name": 2,
                        "topicName": "Radiant",
                        "value": 0,
                        "date": "2016-08-05T00:00:00-07:00"
                    },
                    {
                        "name": 2,
                        "topicName": "Radiant",
                        "value": 2,
                        "date": "2016-08-06T00:00:00-07:00"
                    },
                    {
                        "name": 2,
                        "topicName": "Radiant",
                        "value": 3,
                        "date": "2016-08-07T00:00:00-07:00"
                    },
                    {
                        "name": 2,
                        "topicName": "Radiant",
                        "value": 4,
                        "date": "2016-08-08T00:00:00-07:00"
                    },
                    {
                        "name": 2,
                        "topicName": "Radiant",
                        "value": 3,
                        "date": "2016-08-09T00:00:00-07:00"
                    },
                    {
                        "name": 2,
                        "topicName": "Radiant",
                        "value": 4,
                        "date": "2016-08-10T00:00:00-07:00"
                    },
                    {
                        "name": 2,
                        "topicName": "Radiant",
                        "value": 2,
                        "date": "2016-08-11T00:00:00-07:00"
                    },
                    {
                        "name": 2,
                        "topicName": "Radiant",
                        "value": 1,
                        "date": "2016-08-12T00:00:00-07:00"
                    },
                    {
                        "name": 2,
                        "topicName": "Radiant",
                        "value": 3,
                        "date": "2016-08-13T00:00:00-07:00"
                    },
                    {
                        "name": 2,
                        "topicName": "Radiant",
                        "value": 1,
                        "date": "2016-08-14T00:00:00-07:00"
                    },
                    {
                        "name": 2,
                        "topicName": "Radiant",
                        "value": 2,
                        "date": "2016-08-15T00:00:00-07:00"
                    },
                    {
                        "name": 2,
                        "topicName": "Radiant",
                        "value": 0,
                        "date": "2016-08-16T00:00:00-07:00"
                    },
                    {
                        "name": 2,
                        "topicName": "Radiant",
                        "value": 1,
                        "date": "2016-08-17T00:00:00-07:00"
                    },
                    {
                        "name": 2,
                        "topicName": "Radiant",
                        "value": 3,
                        "date": "2016-08-18T00:00:00-07:00"
                    },
                    {
                        "name": 2,
                        "topicName": "Radiant",
                        "value": 3,
                        "date": "2016-08-19T00:00:00-07:00"
                    },
                    {
                        "name": 2,
                        "topicName": "Radiant",
                        "value": 2,
                        "date": "2016-08-20T00:00:00-07:00"
                    },
                    {
                        "name": 2,
                        "topicName": "Radiant",
                        "value": 3,
                        "date": "2016-08-21T00:00:00-07:00"
                    },
                    {
                        "name": 2,
                        "topicName": "Radiant",
                        "value": 1,
                        "date": "2016-08-22T00:00:00-07:00"
                    },
                    {
                        "name": 2,
                        "topicName": "Radiant",
                        "value": 2,
                        "date": "2016-08-23T00:00:00-07:00"
                    },
                    {
                        "name": 2,
                        "topicName": "Radiant",
                        "value": 3,
                        "date": "2016-08-24T00:00:00-07:00"
                    },
                    {
                        "name": 2,
                        "topicName": "Radiant",
                        "value": 4,
                        "date": "2016-08-25T00:00:00-07:00"
                    },
                    {
                        "name": 2,
                        "topicName": "Radiant",
                        "value": 6,
                        "date": "2016-08-26T00:00:00-07:00"
                    }
                ]
            };

            const colorSchemas = britecharts.colors.colorSchemas;

            // Instantiate Components
            const lineChart = britecharts.line();
            const chartTooltip = britecharts.tooltip();
            const chartLegend = britecharts.legend();
            const chartBrush = britecharts.brush();

            const container = d3.select('.line-container');
            const legendContainer = d3.select('.legend-container');
            const brushContainer = d3.select('.brush-container');

            const containerWidth = container.node().getBoundingClientRect().width;

            // Configure chart
            lineChart
                .margin({ bottom: 50 })
                .height(400)
                .width(containerWidth)
                .colorSchema(colorSchemas.orange)
                .on('customMouseOver', chartTooltip.show)
                .on('customMouseMove', chartTooltip.update)
                .on('customMouseOut', chartTooltip.hide);

            // Render chart
            container.datum(lineData).call(lineChart);

            // Attach tooltip to line chart
            const tooltipContainer = d3.select('.line-container .metadata-group .hover-marker');
            tooltipContainer.call(chartTooltip);

            // Get the legend data
            const legendData = lineData.data.reduce(
                (accum, item) => {
                    let found = accum.find((element) => element.id === item.name);
                    if (found) { return accum; }

                    return [
                        {
                            id: item.name,
                            name: item.topicName
                        },
                        ...accum
                    ];
                },
                []
            );

            // Configure and draw Legend
            chartLegend
                .height(60)
                .width(containerWidth)
                .colorSchema(colorSchemas.orange)
                .isHorizontal(true);

            legendContainer.datum(legendData.reverse()).call(chartLegend);

            // Get the data format for the brush
            const lineDataCopy = JSON.parse(JSON.stringify(lineData));
            const brushData = lineDataCopy.data.reduce(
                (accum, d) => {
                    let found;

                    accum.forEach((item) => {
                        if (item.date === d.date) {
                            item.value = item.value + d.value;
                            found = true;

                            return;
                        }
                    });

                    if (found) {
                        return accum;
                    }

                    return [d, ...accum];
                },
                []
            );

            // Filtering data from line chart
            const isInRange = (startDate, endDate, {date}) => new Date(date) >= startDate && new Date(date) <= endDate;
            const filterData = (brushStart, brushEnd) => {
                // Copy the data
                let lineDataCopy = JSON.parse(JSON.stringify(lineData));

                lineDataCopy.data = lineDataCopy.data.reduce(
                    (accum, item) => {
                        if (!isInRange(brushStart, brushEnd, item)) {
                            return accum;
                        }

                        return [...accum, item];
                    },
                    []
                );

                return lineDataCopy;
            };

            // Configure and draw the brush chart
            chartBrush
                .width(containerWidth)
                .height(100)
                .gradient(colorSchemas.orange.slice(0, 2))
                .xAxisFormat(chartBrush.axisTimeCombinations.DAY_MONTH)
                .margin({ top: 0, bottom: 40, left: 50, right: 30 })
                .on('customBrushEnd', function ([brushStart, brushEnd]) {
                    if (brushStart && brushEnd) {
                        let filteredLineData = filterData(brushStart, brushEnd);

                        container.datum(filteredLineData).call(lineChart);
                    }
                });

            brushContainer.datum(brushData).call(chartBrush);

            // Responsiveness
            const redrawCharts = () => {
                const newContainerWidth = container.node() ? container.node().getBoundingClientRect().width : false;

                // Setting the new width on the components
                lineChart.width(newContainerWidth);
                chartLegend.width(newContainerWidth);
                chartBrush.width(newContainerWidth);

                // Rendering the components again
                container.call(lineChart);
                legendContainer.call(chartLegend);
                brushContainer.call(chartBrush);
            };
            const throttledRedraw = _.throttle(redrawCharts, 200);

            window.addEventListener("resize", throttledRedraw);
        </script>
    </body>
</html>
